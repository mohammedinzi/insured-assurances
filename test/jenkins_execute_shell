#!/bin/bash
set -e

# AWS credentials (from Jenkins secrets)
export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
export AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}

# Config
S3_BUCKET="insured-assurance-artifacts"
S3_KEY="insured-assurance.war"
TOMCAT_USER="jenkins"
TOMCAT_PASS="Jenkins@123"
TOMCAT_HOST="34.207.115.103" # Public IP of Tomcat instance
TOMCAT_PORT="8080"

# Workspace
cd $WORKSPACE

echo "üß± Building WAR package..."
mvn clean package

echo "‚òÅÔ∏è Uploading WAR to S3..."
aws s3 cp target/insured-assurance.war s3://$S3_BUCKET/$S3_KEY --region $AWS_DEFAULT_REGION

echo "‚¨áÔ∏è Downloading WAR locally (to simulate deploy artifact)"
aws s3 cp s3://$S3_BUCKET/$S3_KEY ./insured-assurance.war --region $AWS_DEFAULT_REGION

echo "üöÄ Deploying WAR to Tomcat via Manager API..."
curl -T insured-assurance.war "http://$TOMCAT_USER:$TOMCAT_PASS@$TOMCAT_HOST:$TOMCAT_PORT/manager/text/deploy?path=/&update=true"

echo "‚úÖ Deployment successful!"

#!/bin/bash
set -euxo pipefail

# AWS credentials (injected securely from Jenkins credentials)
export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
export AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}

# Tomcat / S3 config
S3_KEY="insured-assurance.war"
TOMCAT_HOST="100.27.214.51"
TOMCAT_USER="tomcat"
TOMCAT_WEBAPPS="/opt/tomcat/webapps"
PRIVATE_KEY="/var/lib/jenkins/.ssh/tomcat_id_rsa"
S3_BUCKET="insured-assurance-artifacts"

# Build WAR file
echo "üöÄ Building WAR file..."
mvn clean package -DskipTests

# Upload WAR to S3
echo "‚òÅÔ∏è Uploading WAR to S3..."
aws s3 cp target/insured-assurance.war s3://$S3_BUCKET/$S3_KEY

# Deploy WAR to Tomcat
echo "üì¶ Deploying WAR to Tomcat server..."
scp -o StrictHostKeyChecking=no -i $PRIVATE_KEY target/insured-assurance.war \
    $TOMCAT_USER@$TOMCAT_HOST:$TOMCAT_WEBAPPS/ROOT.war

# Restart Tomcat
echo "üîÅ Restarting Tomcat..."
ssh -o StrictHostKeyChecking=no -i $PRIVATE_KEY $TOMCAT_USER@$TOMCAT_HOST \
    "sudo systemctl restart tomcat"

echo "‚úÖ Deployment completed successfully!"

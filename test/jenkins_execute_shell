#!/bin/bash
set -e

# AWS credentials from Jenkins secret text
export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
export AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION

# Hard-coded Tomcat/S3 info
S3_KEY="insured-assurance.war"
TOMCAT_HOST="100.27.214.51"
TOMCAT_USER="tomcat"
TOMCAT_WEBAPPS="/opt/tomcat/webapps"
PRIVATE_KEY="/var/lib/jenkins/.ssh/tomcat_id_rsa"
S3_BUCKET="insured-assurance-artifacts"

# Build WAR (optional if Jenkins builds it)
cd $WORKSPACE
mvn clean package

# Upload WAR to S3
aws s3 cp target/insured-assurance.war s3://$S3_BUCKET/$S3_KEY --region $AWS_DEFAULT_REGION

# Deploy WAR to Tomcat
scp -i $PRIVATE_KEY target/insured-assurance.war $TOMCAT_USER@$TOMCAT_HOST:$TOMCAT_WEBAPPS/ROOT.war

# Restart Tomcat
ssh -i $PRIVATE_KEY $TOMCAT_USER@$TOMCAT_HOST "sudo systemctl restart tomcat"

echo "Deployment completed successfully!"
